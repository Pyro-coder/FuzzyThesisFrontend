{% extends "layout.html" %}

{% block content %}
<form method="post" id="pclrForm">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Traits</th>
                    <th>Score</th>
                    <th>
                        Importance
                        <label>
                            <input type="checkbox" id="importanceToggle"> Enable Editing
                        </label>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for item in criteria %}
                <tr>
                    <td class="traits-cell">{{ item.name }}</td>
                    <td>
                        <div class="radio-group">
                            {% for score in scoring_criteria[item.name] %}
                            <label>
                                <input type="radio" name="{{ item.name }}_score" value="{{ score }}" class="pclr-term"> {{ score }}
                            </label>
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        <select name="{{ item.name }}_importance" class="importance-dropdown" data-enabled="false">
                            <option value="Low" {% if item.default_importance == "Low" %}selected{% endif %}>Low</option>
                            <option value="Moderate" {% if item.default_importance == "Moderate" %}selected{% endif %}>Moderate</option>
                            <option value="High" {% if item.default_importance == "High" %}selected{% endif %}>High</option>
                            <option value="Very High" {% if item.default_importance == "Very High" %}selected{% endif %}>Very High</option>
                            <option value="Maximum" {% if item.default_importance == "Maximum" %}selected{% endif %}>Maximum</option>
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Hidden input for reCAPTCHA -->
    <input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response">

    <div class="button-container">
        <button type="submit" id="submitButton" class="g-recaptcha"
            data-sitekey="6LfzR88qAAAAAMFgZgD0Y5qpis6eFuNash-hi1C1"
            data-callback="onSubmit"
            data-badge="bottomright">
            Submit
        </button>
    </div>
</form>

<script src="https://www.google.com/recaptcha/api.js"></script>
<script>
    function onSubmit(token) {
        if (validateForm()) {
            document.getElementById("pclrForm").submit();
        } else {
            grecaptcha.reset(); // Reset reCAPTCHA so the user can try again
        }
    }

    function validateForm() {
        let valid = true;
        let radioGroups = document.querySelectorAll('.radio-group');
        let recaptchaResponse = document.getElementById("g-recaptcha-response").value;

        // Ensure at least one radio button is selected for each trait
        radioGroups.forEach(function (group) {
            let radios = group.querySelectorAll('input[type="radio"]');
            let isChecked = Array.from(radios).some(radio => radio.checked);
            if (!isChecked) {
                valid = false;
            }
        });

        if (!valid) {
            alert('Please select a value for all PCLR terms.');
            return false;
        }

        // Ensure reCAPTCHA has been completed
        if (!recaptchaResponse) {
            grecaptcha.reset(); // Reset in case of an issue
            grecaptcha.execute(); // Manually trigger reCAPTCHA
            return false;
        }

        return true;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const importanceDropdowns = document.querySelectorAll('.importance-dropdown');
        importanceDropdowns.forEach(function (dropdown) {
            if (dropdown.getAttribute('data-enabled') === 'false') {
                dropdown.classList.add('disabled-dropdown');
            }
        });

        document.getElementById('pclrForm').addEventListener('submit', function (event) {
            if (!validateForm()) {
                event.preventDefault();
            }
        });

        document.getElementById('importanceToggle').addEventListener('change', function (event) {
            const isEnabled = event.target.checked;
            const importanceDropdowns = document.querySelectorAll('.importance-dropdown');

            importanceDropdowns.forEach(function (dropdown) {
                if (isEnabled) {
                    dropdown.removeAttribute('data-enabled');
                    dropdown.classList.remove('disabled-dropdown');
                } else {
                    dropdown.setAttribute('data-enabled', 'false');
                    dropdown.classList.add('disabled-dropdown');
                }
            });
        });

        document.addEventListener('mousedown', function (event) {
            if (event.target.matches('.importance-dropdown[data-enabled="false"]')) {
                event.preventDefault();
            }
        });

        // Prevent form submission using Enter key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        });
    });



</script>



<style>
    /* Custom style to indicate visually disabled dropdowns */
    .disabled-dropdown {
        pointer-events: none;
        background-color: #e9ecef;
        color: #6c757d;
    }

    /* Optional styling for the checkbox label */
    #importanceToggle {
        margin-left: 10px;
    }
</style>
{% endblock %}
